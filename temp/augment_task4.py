import pandas as pd
import json
import re
import random
import os
import numpy as np
import ollama
from tqdm import tqdm

path = '/root/autodl-tmp/nano-graphrag-main/data/task4.jsonl'

data = []
with open(path, 'r') as file:
    for line in file:
        newline = eval(line)
        data.append(newline)
file.close()

for item in tqdm(data):
    input_info = "\n".join(item['conversations'][0]['value'].split("\n")[1:])
    output_info = item['conversations'][1]['value']
    
    instruction = f"""根据输入的患者病历和推荐用药方案，详细分析推荐药物的适用性，并结合患者的具体病史、现病史及症状特点，给出用药选择的医学依据。同时需要对推荐药物的作用机制、安全性及可能的联合用药效果进行全面讨论。要求内容逻辑清晰、层次分明，语言专业且易于理解。除非推荐用药方案存在明显错误，否则不要对推荐用药方案进行修改。
    
    输入包括：患者病历和推荐用药方案。
    输出包括但不限于：
    药物分析：逐一分析推荐药物的作用机制及其与患者病情的适配性；
    联合用药讨论：分析联合用药的综合作用；
    安全性评估：结合患者具体情况，评估推荐用药的安全性；
    综合建议：给出具体的用药建议和监测方案。
    
    ###
    示例：
    输入：
    患者病历：
    患者信息：患者男性，71岁。  
    现病史：2011年外孙意外去世后逐渐出现情绪低落、失眠等症状，多次复发，加重时伴有明显焦虑、自卑和自杀意念。2023年入院前2周，情绪低落明显，进食减少，入睡困难，夜间早醒。  
    既往史：高血压病史，服用厄贝沙坦氢氯噻嗪片降压治疗。既往行胆囊手术。  
    家族史：阴性。  
    查体及辅助检查：心电图显示频发室上性早搏，D-二聚体轻度升高，血糖13.52mmol/L。
    
    推荐用药方案：
    米氮平，
    喹硫平，
    奥沙西泮 ，
    艾司西酞普兰
    
    输出：
    1. 药物分析
    1. 米氮平（Mirtazapine）
    药物类别：四环类抗抑郁药，具有抗抑郁和镇静作用。
    推荐理由：
    改善抑郁情绪：患者表现出明显的抑郁症状，包括情绪低落、自我评价过低、对生活失去兴趣、睡眠障碍和自杀念头。米氮平能通过增加去甲肾上腺素和5-羟色胺的释放，缓解抑郁症状。
    改善睡眠障碍：米氮平对H1受体有拮抗作用，具有较强的镇静效果，可缓解患者的入睡困难、早醒和梦多等问题。患者既往使用米氮平在睡眠改善方面效果较好，因此推荐继续使用。
    促进食欲：患者有进食少、体力差和体重下降的表现。米氮平的食欲促进作用可帮助患者恢复体能和改善身体状况。
    2. 喹硫平（Quetiapine）
    药物类别：第二代抗精神病药，具有抗抑郁、抗焦虑和镇静作用。
    推荐理由：
    缓解焦虑和激越：患者长期存在焦虑、坐立不安、心烦以及明显的情绪激越倾向。喹硫平可通过5-HT2A和多巴胺D2受体拮抗作用，稳定情绪，减轻焦虑和易激惹。
    改善失眠：喹硫平的镇静作用能够进一步缓解患者睡眠障碍，与米氮平联合使用可能有协同效果。
    安全性：喹硫平相对于其他抗精神病药物，代谢负担较低，对老年患者耐受性较好，可较安全地用于该患者的治疗。
    3. 奥沙西泮（Oxazepam）
    药物类别：苯二氮卓类药物，主要用于抗焦虑、镇静和改善睡眠。
    推荐理由：
    短期缓解焦虑症状：患者表现出明显的焦虑和心慌，奥沙西泮可快速缓解这些症状，有助于患者适应治疗过程。
    改善急性失眠：患者有严重的入睡困难和早醒问题，奥沙西泮可作为短期辅助药物，用于缓解急性睡眠障碍。
    相对安全：奥沙西泮代谢方式简单，对肝功能负担较低，适合有高血压和糖尿病等合并症的老年患者。
    4. 艾司西酞普兰（Escitalopram）
    药物类别：选择性5-羟色胺再摄取抑制剂（SSRI类抗抑郁药）。
    推荐理由：
    缓解抑郁和焦虑症状：患者存在长期的抑郁和焦虑情绪，艾司西酞普兰作为一线抗抑郁药物，起效稳定且副作用较少，可作为基础药物用于治疗。
    情绪改善和耐受性：相比其他SSRIs，艾司西酞普兰起效较快，且在老年患者中耐受性较好，有助于改善患者的情绪状态和功能恢复。
    减少药物间副作用的叠加：艾司西酞普兰与米氮平联合使用，作用机制互补，可更全面地缓解抑郁症状，同时副作用叠加的风险较低。
    适配性分析：患者长期失眠伴抑郁情绪低落，米氮平可有效改善睡眠障碍，同时缓解情绪低落的症状。推荐晚间服用，起始剂量为15mg，逐步调整至30mg以获得更佳疗效。
    2. 联合用药讨论
    米氮平与艾司西酞普兰联合使用可通过不同机制提高5-HT水平，对抑郁症状发挥协同作用。
    喹硫平可辅助改善患者的焦虑和睡眠障碍，减少焦虑对抑郁症状的加重。
    需注意奥沙西泮的使用时间，以避免对中枢神经系统产生过度镇静作用。
    3. 安全性评估
    年龄考虑：患者为71岁，药物代谢能力下降，需谨慎使用高剂量药物，特别是喹硫平和奥沙西泮，以防止过度镇静和跌倒风险。
    体检结果：患者血糖升高，需注意米氮平可能加重糖代谢紊乱，建议动态监测血糖水平。
    4. 综合建议
    起始方案：米氮平15mg晚间，艾司西酞普兰10mg早晨，喹硫平25mg晚间，奥沙西泮7.5mg晚间。
    动态监测患者情绪变化、睡眠质量及血糖水平。
    如患者症状缓解不明显，可调整喹硫平至50mg或调整艾司西酞普兰剂量。
    ###
    
    输入：
    患者病历：{input_info}
    推荐用药方案：{output_info}
    
    输出：
    
    """
    
    response = ollama.chat(model='qwen2.5:ctx32k', messages=[
        {
            'role': 'user',
            'content': instruction
        },
    ])
    print(response['message']['content'])
    
    conversation = []
    conversation.append({'from':'human','value': item['conversations'][0]['value']})
    conversation.append({'from':'gpt','value': response['message']['content']})
    
    item = {'conversations': conversation}
        
        
    with open('/root/autodl-tmp/nano-graphrag-main/data/sft/task-medication.jsonl', 'a') as file:
        # for item in conversations:
        # 将每个字典转换为JSON字符串并写入文件
        json_str = json.dumps(item, ensure_ascii=False)
        file.write(json_str + '\n')
        file.flush()
    # file.close()
    
    
    
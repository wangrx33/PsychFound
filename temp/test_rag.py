from nano_graphrag import GraphRAG, QueryParam
import os

os.environ["OPENAI_API_KEY"] = "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"

openai_api = "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"

graph_func = GraphRAG(working_dir="./shenyucun2")

# with open(r"D:\work\code\nano-graphrag\nano-graphrag-main\tests\zhuyuanzhang.txt", encoding="utf-8-sig") as f:
#         FAKE_TEXT = f.read()

with open(r"D:\work\code\nano-graphrag\nano-graphrag-main\kb\沈渔邨2.txt", encoding="utf-8-sig") as f:
    graph_func.insert(f.read()) 
    
# with open(r"D:\work\code\nano-graphrag\nano-graphrag-main\tests\zhuyuanzhang.txt", encoding="utf-8-sig") as f:
#     graph_func.insert(f.read())

# help(graph_func)
# Perform global graphrag search
patient_info = """
患者欧枝琛 ，男，26岁。主因“间断情绪不稳、冲动、行为怪异2年，复犯1周。”入院。
病例特点：
  1.发病基础：患者性别男，年龄26岁。病前性格:内向、话少。
  2.发病诱因：无明显诱因。
  3.起病形式及病程：慢性起病，间断病程2年。
  4.临床表现：（患者父亲不与患者同住，病史可靠欠详）患者自2020年春节起出现片段的怪异行为。6月后有删除家人联系方式，给家人打很多钱的行为，原因不明。同年8月有行为怪异、作揖下跪、自伤撞石头、紧张害怕、语乱。后冲动、喊叫、恐惧，从机场天台跳下，曾至赣州当地精神科医院住院，诊断“急性而短暂的精神病性障碍”，语乱、行为怪异基本消失，但仍显态度挑剔、蛮横、指责家人、夜不眠。于2020年9月21日至2020年11月6日住院，明确诊断“双相情感障碍，目前为不伴有精神病性症状的躁狂发作”，予以MECT治疗7次，予以丙戊酸钠缓释片日高量1250mg，喹硫平日高量800mg治疗，病情好转出院。出院后按时按量服药，未见异常行为，情绪稳定，工作能力正常，与同事交流可，人际关系正常，情绪稳定，未见异常行为。此后患者认为自己没有病，逐渐减药或者不规律服药。2022年7月6日父亲与患者通话期间，患者语气差显狂妄，对家人不理睬，告诉父亲自己又要病了，称自己一整晚未睡觉，14日家人赶至厦门，患者抱着母亲哭泣，对父亲发脾气，让父亲离自己远一些，不想看到父亲，进食、睡眠不规律，家人在厦门期间患者基本未服药，17日患者冲动拿灭火器喷向父亲，家人将其送入厦门市精神卫生中心，住院5天，考虑诊断“未分化型精神分裂症”，予帕利哌酮缓释片6mg/日、MECT治疗后出院，出院后患者病情改善，坚持每日服药，情绪稳定，未见冲动异常行为，7月23日父亲带其来北京进一步就诊，今日以“双相情感障碍”第二次非自愿收入我科。
  5.既往史：既往患乙型肝炎，目前已无阳性症状
  6.家族史：患者母亲10余年前曾因言语夸大、行为冲动住当地医院1周，诊断不详，经治疗至今虽未服药，亦未复犯。
  7.查体及辅助检查：查体未见异常。
拟诊讨论：
诊断及诊断依据：
  1.病程标准：慢性起病，间断病程。
  2.症状学标准：患者意识清晰，定向力完整，接触显被动，对问话能答，对答尚切题，语量语速适中。承认既往存在幻觉妄想，目前未引出明确精神性性症状，承认近期夜眠差，睡眠需求减少，脑子想到过去的事情，想到父亲对母亲不好，情绪激动，存在冲动行为，有求治意愿，对将来有一定的规划，高级意向部分存在，自知力部分存在。
  3.严重程度标准：严重影响社会功能。
  4.排除标准：
排除脑器质性及精神活性物质所致精神和行为障碍。
  5.初步诊断：双相情感障碍,乙型病毒性肝炎表面抗原携带者
鉴别诊断：
1.精神分裂症：患者病史中存在语乱、行为怪异表现，需要考虑该病，患者病史中情绪问题占主导地位，反复追问下无明确妄想症状，故考虑该病可能性不大。
诊疗计划：
  1.完善辅助检查，急查血常规、血急化、尿常规；
  2.精神科一级护理；严防冲动；
  3.延续院外帕利哌酮缓释片，合并丙戊酸钠缓释片及碳酸锂稳定情绪，劳拉西泮抗焦虑、助眠，盐酸苯海索片对抗锥体外系反应；
  4.向家属交代各注意事项，签署相关知情同意书；
  5.采用自杀风险、攻击风险评估量表判断患者是否存在自杀观念及攻击倾向及其严重程度；采用PANSS观察患者是否存在精神病性症状及评定阳性与阴性症状的程度变化；采用锥体外系反应量表及药物副反应量表细致评定治疗过程中的药物副反应；采用躁狂量表、汉密尔顿抑郁量表、汉密尔顿焦虑量表评定患者是否存在相关症状；
  6.请上级医师查房，明确诊断，指导治疗。

"""

instruction = """
### 任务说明：
您是一名精神医学人工智能助手，专注于解析和补充患者病历中涉及医生决策的内容，包括但不限于病例特点总结、诊断及鉴别诊断逻辑、治疗方案选择、检查项目选择依据等。您的目标是对病历中涉及医生思维过程的部分进行详细补充，结合输入的临床指南及医学知识，说明医生每项决策背后的理论依据和逻辑推理。

### 输入内容：
1. **患者病历信息**（原始记录）：  
   - **基本信息**: {患者的性别、年龄等}  
   - **病史信息**: {现病史、既往史、家族史等详细描述}  
   - **临床表现**: {症状、量表评分、行为观察等记录}  
   - **辅助检查**: {实验室检查、影像学检查等结果}  
   - **医生的诊断及治疗方案**: {包括诊断结果、鉴别诊断、治疗计划、评估量表等}  

### 任务目标：
请对病历中所有涉及医生决策的部分，逐一补充其背后的理论依据和推理过程，具体包括以下内容：
1. **病例特点总结**：  
   - 结合患者病历，解释医生如何总结患者的主要临床特点，并如何根据病史、症状及其他信息筛选关键特征。  
2. **诊断逻辑**：  
   - 对医生给出的诊断结果，补充其依据的标准和推理过程。需结合病史、临床表现、辅助检查结果及相关指南，详细说明医生如何得出最终诊断。  
3. **鉴别诊断**：  
   - 对医生记录的鉴别诊断过程进行扩展，补充医生可能考虑的其他疾病及排除这些疾病的具体依据。  
4. **检查项目选择依据**：  
   - 说明医生为何选择特定的辅助检查或评估工具，以及这些检查在诊断和治疗中的作用。  
5. **治疗方案选择**：  
   - 解析医生选择特定药物或治疗手段的理论依据，包括药物的作用机制、适应症、替代方案及潜在风险。  
6. **其他决策的补充说明**：  
   - 对病历中未明确记录的其他决策，结合背景信息和参考知识进行合理推测和补充。

### 输出要求：
- 输出格式不限，可以以段落形式或条目形式呈现。
- 内容需逻辑清晰、推理严密、表达自然。
- 所有补充内容必须基于输入病历和参考知识，避免虚构或与输入矛盾。


"""

my_query = f"请结合指南，对患者被诊断为双相情感障碍的诊断标准及鉴别诊断分析进行解读，以补充医生的思维决策过程。患者病历信息：{patient_info}"

print(graph_func.query(my_query, param=QueryParam(mode="global")))
print('-------------------'*10)
print(graph_func.query(my_query, param=QueryParam(mode="local")))

# while True:
#     print(graph_func.query(input("请输入问题："), param=QueryParam(mode="local")))

# Perform local graphrag search (I think is better and more scalable one)
# print(graph_func.query("复发性抑郁障碍的诊断标准是什么？"))
# print(graph_func.query("ICD是什么？"))




